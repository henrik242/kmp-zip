package no.synth.kmpio.zip

import kotlinx.cinterop.ExperimentalForeignApi
import kotlinx.cinterop.addressOf
import kotlinx.cinterop.usePinned
import platform.Foundation.NSData
import platform.Foundation.dataWithContentsOfFile
import platform.posix.memcpy

@OptIn(ExperimentalForeignApi::class)
actual object TestData {
    private const val RESOURCE_DIR = "@@RESOURCE_DIR@@"

    actual fun loadResource(name: String): ByteArray {
        val path = RESOURCE_DIR + "/" + name
        val data = NSData.dataWithContentsOfFile(path)
            ?: error("Test resource not found: $path")
        val bytes = ByteArray(data.length.toInt())
        if (bytes.isNotEmpty()) {
            bytes.usePinned { pinned ->
                memcpy(pinned.addressOf(0), data.bytes, data.length)
            }
        }
        return bytes
    }

    actual val storedZip: ByteArray get() = loadResource("stored.zip")
    actual val deflatedZip: ByteArray get() = loadResource("deflated.zip")
    actual val multiEntryZip: ByteArray get() = loadResource("multi-entry.zip")
    actual val directoryZip: ByteArray get() = loadResource("directory.zip")
    actual val emptyZip: ByteArray get() = loadResource("empty.zip")
    actual val binaryZip: ByteArray get() = loadResource("binary.zip")
    actual val cliStoredZip: ByteArray get() = loadResource("cli-stored.zip")
    actual val cliDeflatedZip: ByteArray get() = loadResource("cli-deflated.zip")
    actual val cliWithDirZip: ByteArray get() = loadResource("cli-with-dir.zip")
    actual val cliMixedZip: ByteArray get() = loadResource("cli-mixed.zip")
    actual val sevenStoredZip: ByteArray get() = loadResource("seven-stored.zip")
    actual val sevenDeflatedZip: ByteArray get() = loadResource("seven-deflated.zip")
}
